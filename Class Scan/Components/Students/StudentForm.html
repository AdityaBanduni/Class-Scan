import React, { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { UploadFile } from "@/integrations/Core";
import { Upload, X, User, Save } from "lucide-react";
import { motion } from "framer-motion";

export default function StudentForm({ student, onSubmit, onCancel }) {
    const [formData, setFormData] = useState(student || {
        full_name: '',
        student_id: '',
        grade: '',
        email: '',
        parent_email: '',
        photo_url: '',
        status: 'active'
    });
    const [isUploading, setIsUploading] = useState(false);
    const [photoPreview, setPhotoPreview] = useState(student?.photo_url || '');

    const handleInputChange = (field, value) => {
        setFormData(prev => ({
            ...prev,
            [field]: value
        }));
    };

    const handlePhotoUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setIsUploading(true);
        try {
            const { file_url } = await UploadFile({ file });
            setFormData(prev => ({
                ...prev,
                photo_url: file_url
            }));
            setPhotoPreview(file_url);
        } catch (error) {
            console.error("Error uploading photo:", error);
        }
        setIsUploading(false);
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        onSubmit(formData);
    };

    return (
        <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
        >
            <Card className="bg-white/95 backdrop-blur-sm shadow-2xl border-0">
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <User className="w-5 h-5 text-blue-600" />
                        {student ? 'Edit Student' : 'Add New Student'}
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        {/* Photo Upload */}
                        <div className="text-center">
                            <div className="relative inline-block">
                                <div className="w-24 h-24 bg-gradient-to-r from-gray-200 to-gray-300 rounded-full flex items-center justify-center overflow-hidden shadow-lg">
                                    {photoPreview ? (
                                        <img src={photoPreview} alt="Student" className="w-full h-full object-cover" />
                                    ) : (
                                        <User className="w-8 h-8 text-gray-500" />
                                    )}
                                </div>
                                <input
                                    type="file"
                                    accept="image/*"
                                    onChange={handlePhotoUpload}
                                    className="absolute inset-0 opacity-0 cursor-pointer"
                                    disabled={isUploading}
                                />
                                {isUploading && (
                                    <div className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center">
                                        <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-white" />
                                    </div>
                                )}
                            </div>
                            <p className="text-sm text-gray-500 mt-2">
                                Click to upload student photo
                            </p>
                        </div>

                        {/* Form Fields */}
                        <div className="grid md:grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <Label htmlFor="full_name">Full Name *</Label>
                                <Input
                                    id="full_name"
                                    value={formData.full_name}
                                    onChange={(e) => handleInputChange('full_name', e.target.value)}
                                    placeholder="Enter student's full name"
                                    required
                                />
                            </div>
                            
                            <div className="space-y-2">
                                <Label htmlFor="student_id">Student ID *</Label>
                                <Input
                                    id="student_id"
                                    value={formData.student_id}
                                    onChange={(e) => handleInputChange('student_id', e.target.value)}
                                    placeholder="Enter unique student ID"
                                    required
                                />
                            </div>
                            
                            <div className="space-y-2">
                                <Label htmlFor="grade">Grade</Label>
                                <Select
                                    value={formData.grade}
                                    onValueChange={(value) => handleInputChange('grade', value)}
                                >
                                    <SelectTrigger>
                                        <SelectValue placeholder="Select grade" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="K">Kindergarten</SelectItem>
                                        <SelectItem value="1">Grade 1</SelectItem>
                                        <SelectItem value="2">Grade 2</SelectItem>
                                        <SelectItem value="3">Grade 3</SelectItem>
                                        <SelectItem value="4">Grade 4</SelectItem>
                                        <SelectItem value="5">Grade 5</SelectItem>
                                        <SelectItem value="6">Grade 6</SelectItem>
                                        <SelectItem value="7">Grade 7</SelectItem>
                                        <SelectItem value="8">Grade 8</SelectItem>
                                        <SelectItem value="9">Grade 9</SelectItem>
                                        <SelectItem value="10">Grade 10</SelectItem>
                                        <SelectItem value="11">Grade 11</SelectItem>
                                        <SelectItem value="12">Grade 12</SelectItem>
                                    </SelectContent>
                                </Select>
                            </div>
                            
                            <div className="space-y-2">
                                <Label htmlFor="status">Status</Label>
                                <Select
                                    value={formData.status}
                                    onValueChange={(value) => handleInputChange('status', value)}
                                >
                                    <SelectTrigger>
                                        <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="active">Active</SelectItem>
                                        <SelectItem value="inactive">Inactive</SelectItem>
                                    </SelectContent>
                                </Select>
                            </div>
                            
                            <div className="space-y-2">
                                <Label htmlFor="email">Student Email</Label>
                                <Input
                                    id="email"
                                    type="email"
                                    value={formData.email}
                                    onChange={(e) => handleInputChange('email', e.target.value)}
                                    placeholder="student@school.edu"
                                />
                            </div>
                            
                            <div className="space-y-2">
                                <Label htmlFor="parent_email">Parent Email</Label>
                                <Input
                                    id="parent_email"
                                    type="email"
                                    value={formData.parent_email}
                                    onChange={(e) => handleInputChange('parent_email', e.target.value)}
                                    placeholder="parent@email.com"
                                />
                            </div>
                        </div>
                        
                        {/* Action Buttons */}
                        <div className="flex gap-3 pt-4">
                            <Button
                                type="button"
                                variant="outline"
                                onClick={onCancel}
                                className="flex-1"
                            >
                                <X className="w-4 h-4 mr-2" />
                                Cancel
                            </Button>
                            <Button
                                type="submit"
                                className="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700"
                            >
                                <Save className="w-4 h-4 mr-2" />
                                {student ? 'Update' : 'Add'} Student
                            </Button>
                        </div>
                    </form>
                </CardContent>
            </Card>
        </motion.div>
    );
}